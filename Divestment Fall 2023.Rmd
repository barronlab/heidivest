
---
title: "Divestment Analysis for Barron et al. 2023 Elementa"
authors: "Rachel Venator, Jane Andrews, and Junwen Ding, Alex Barron advising"
date: "2023-10-20"
output: html_document
---
## Setup
```{r library, include=FALSE}
require(readr)
library(readxl)
require(plyr)
require(dplyr)
require(ggplot2)
require(lattice)
require(latticeExtra)
require(reshape2)
library(tidyverse)
library(cowplot)
library(colorspace)
library(ggrepel)
library(ggpubr)
library(lmtest)
library(stargazer)
library(lubridate)
```
 
```{r import}
### Import mannually compiled divested data (#144), rejected (#76), and U.S. Dept of Education IPEDS private (#19915) and public institutions (#17382) 

#The "f_f1a_data" and the "f_f2_data" datasets are from the IPEDS database and have been generated by running a list of institutions (criteria for institutions given below) through a shiny app written by IR department members at Smith College and Tufts University.

#For both the private-not-for-profit (f_f2_data) and the public (f_f1a_data) institutions both 4 yr + and 2 yr institutions that were degree-granting and had an endowment in FY 2020 (the most recent year of data available) were included.  The University of Colorado Systems Office was manually added to the peerlist for the public set.

f_f1a_datax <- read.csv("f_f1a(public) 2020.csv")
f_f2_datax <- read.csv("f_f2(private) 2020.csv")

# The "divested" and "rejected" datasets were created based off of data on fossil fuel divestment decisions gathered by Smith College. 

divestedx <- read.csv ("Divested Institutions Fall 2023_final.csv")
rejectedx <- read.csv("Rejected Institutions Spring 2022.csv")
rejected_detailsx <- read.csv("Rejections_data Spring 2022_final.csv")
```

```{r rename columns}
# Delete extraneous columns
#f_f1a_data[,c(3,5:23,25:50,53:65,67:73,75:162,164:197,199:230)] <- NULL
f_f1a_datax2 <- f_f1a_datax %>%
  select("UNITID", "ACAD_YEAR", "TABLE_TRIM", "Auxiliary.enterprises....Current.year.total", "Does.this.institution.or.any.of.its.foundations.or.other.affiliated.organizations.own.endowment.assets..", "Does.this.institution.or.any.of.its.foundations.or.other.affiliated.organizations.own.endowment.assets.._value", "Hospital.services...Current.year.total", "Independent.operations...Current.year.total", "Research...Current.year.total", "Total.expenses.and.deductions...Current.year.total", "Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year", "Value.of.endowment.assets.at.the.end.of.the.fiscal.year", "INSTITUTION.NAME")

f_f2_datax2 <- f_f2_datax %>% 
   select("UNITID", "ACAD_YEAR", "TABLE_TRIM", "Auxiliary.enterprises.Total.amount", "Does.this.institution.or.any.of.its.foundations.or.other.affiliated.organizations.own.endowment.assets..", "Does.this.institution.or.any.of.its.foundations.or.other.affiliated.organizations.own.endowment.assets.._value", "Hospital.services.Total.amount", "Independent.operations.Total.Amount", "Research.Total.amount", "Total.expenses.Total.amount", "Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year", "Value.of.endowment.assets.at.the.end.of.the.fiscal.year", "INSTITUTION.NAME")
#f_f2_data[,c(3,5:21,23:29,32:48,50:55,57:159,161:191,193:207)] <- NULL
# Rename columns for merge
colnames(f_f1a_datax2)[colnames(f_f1a_datax2) == "Auxiliary.enterprises....Current.year.total"] <- "Auxiliary.enterprises.Total.amount"
colnames(f_f1a_datax2)[colnames(f_f1a_datax2) == "Hospital.services...Current.year.total"] <- "Hospital.services.Total.amount"
colnames(f_f1a_datax2)[colnames(f_f1a_datax2) == "Research...Current.year.total"] <- "Research.Total.amount"
colnames(f_f1a_datax2)[colnames(f_f1a_datax2) == "Total.expenses.and.deductions...Current.year.total"] <- "Total.expenses.Total.amount"
colnames(f_f1a_datax2)[colnames(f_f1a_datax2) == "Independent.operations...Current.year.total"] <- "Independent.operations.Total.Amount"
f_f1a_datax2$Independent.operations.Total.Amount <- as.numeric(f_f1a_datax2$Independent.operations.Total.Amount)
f_f1a_datax2$Research.Total.amount <- as.numeric(f_f1a_datax2$Research.Total.amount)
# Check that classes of columns match
f1ax <- lapply(f_f1a_datax2, class)
f2x <- lapply(f_f2_datax2, class)
identical(f1ax, f2x)
```

### Merge private & public institutions endowment data and divestment & rejection data
```{r merged_data}
# Merge private and public institutions endowment data
merged_data <- bind_rows(f_f1a_datax2, f_f2_datax2, .id = NULL)
# Create a clean copy to be used later for MICE Imputation
merged_data_clean <- data.frame(merged_data)
### Manually adding Antioch University System Office due to failed import 
new_row <- data.frame(440138,2020,'F_F2',9244936,'Yes - (report endowment assets))', 1,	0,	0,	88504,	68155040,	7700762,	8012169,	'Antioch University-System Administration')
names(new_row) <- names(merged_data)
merged_data <- rbind(merged_data, new_row)
```

```{r divest_reject_raw}
# Merge divestment and rejection data
divest_reject_raw <- bind_rows(divestedx, rejectedx, .id = NULL)

# Add operating expenses (OPEX) column
# OPEX = Total Expenses - (Research + Auxiliary + Hospital + Independent Operations)
# Formula for OPEX is from Smith College's IR department
merged_data$OPEX <- merged_data$Total.expenses.Total.amount - (merged_data$Auxiliary.enterprises.Total.amount + merged_data$Hospital.services.Total.amount + merged_data$Independent.operations.Total.Amount + merged_data$Research.Total.amount)
# Change scale of endowment value column to billions of dollars
merged_data$Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year <- (merged_data$Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year/1000000000)
# Change scale of endowment value at the end of the year column to billions of dollars
merged_data$Value.of.endowment.assets.at.the.end.of.the.fiscal.year <- (merged_data$Value.of.endowment.assets.at.the.end.of.the.fiscal.year/1000000000)
# Change scale of OPEX column to billions of dollars
merged_data$OPEX <- (merged_data$OPEX/1000000000)
```

### Add endowment dependency column
```{r merged_data_2}
# n keeps track of row numbers
n <- 0

# Create endowment dependency column
# Calculations for endowment dependency are based on endowment size (see TIAA-NACUBO report)

merged_data$Endowment_dependency <- NA

for (i in merged_data$UNITID){
  
  # Update row number
  n <- n + 1
  
  v = merged_data[n, "Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year"]
  o = merged_data[n, "OPEX"]
  
  if (is.na(v)){
    next
  }
  if (v > 1) {
    merged_data[n, "Endowment_dependency"] <- (v * 0.047) / o
  }
  
  if (v > .5 & v <= 1) {
    merged_data[n, "Endowment_dependency"] <- (v * 0.045) / o
  }
  
  if (v > .25 & v <= .5) {
    merged_data[n, "Endowment_dependency"] <- (v * 0.046) / o
  }
  
  if (v > .1 & v <=.25) {
    merged_data[n, "Endowment_dependency"] <- (v * 0.047) / o
  }
  if (v > .05 & v <= .1) {
    merged_data[n, "Endowment_dependency"] <- (v * 0.045) / o
  }
  
  if (v >= .025 & v <= .05) {
    merged_data[n, "Endowment_dependency"] <- (v * 0.039) / o
  }
  
  else
    merged_data[n, "Endowment_dependency"] <- (v * 0.041) / o
}

# Add data from the merged "divested" and "rejected" data sets to the merged IPEDS dataset
merged_data <- left_join(merged_data, divest_reject_raw, by = "UNITID")
```
## Data prep: Sample size summary 
```{r merged_data_2020}
library(readr)
four_year_institutions <- read_csv("Private-not-for-profit and public 4-year-institution name list.csv")

merged_data_2020 <- merged_data[which(merged_data$ACAD_YEAR == 2020),]
#Filter out the community colleges from merged_data_2020
setdiff(merged_data_2020$INSTITUTION.NAME,four_year_institutions$`Institution Name`)
#Antioch U will show up due to name mismatch on 4year list

merged_data_2020<-merged_data_2020%>%
  inner_join( four_year_institutions, by=c('UNITID'='UnitID'))

#684 public 
public_count<- count(merged_data[which(merged_data_2020$`Sector of institution (HD2020)` == 1),] )
public_count
#1306 private 
private_count<- count(merged_data[which(merged_data_2020$`Sector of institution (HD2020)` == 2),] )
private_count
reversed_data<-merged_data_2020%>%
  filter(merged_data_2020$Reversed.Decision=="Yes")

print(paste0("There are ",count(merged_data_2020)-count(reversed_data)," US institutions available in the sample dataset after excluding ", count(reversed_data), " double counts of reversed decisions"))
```

```{r ed_data_null}
# reversed double counts but keep all divestment status (including NAs) from merged_data_2020
ed_data_null<- merged_data_2020%>%
  filter(Divested.=="Yes" |is.na(Divested.) | Divested. == 'No'  & Reversed.Decision!="Yes")

identical(count(ed_data_null), count(merged_data_2020)-count(reversed_data))
```

```{r div_data}
#Divested schools 
# Identify relevant subset of data
# Endowment amount used is 2020 IPEDS figure. 
div_data <- merged_data[which(merged_data$ACAD_YEAR == 2020 & merged_data$Divested.== "Yes"),]
```

```{r diff_div}
#div_data losing 6 schools from divestedx - this represents 2 year colleges and one closed school (GMC) 
print("These schools are in mannually compiled divestedx but not in div_data")
diff_div<-setdiff(divestedx$UNITID, div_data$UNITID)
diff_div

#Current output 230898 GMC 125170 BCC 108667 Alameda 117247 Laney 118772 Merrit 209746 PCC
```

```{r rejection}
print("These schools are in mannually compiled rejectedx but not in rejected_details")
diff_divR<-setdiff(rejectedx$UNITID, rejected_detailsx$UNITID)
diff_divR
```

```{r diff_div2}
print("These schools have no matching records in merged_data:")
diff_div2<-setdiff(diff_div, merged_data$School.Name)
diff_div2
```

```{r diff in merged_data not in div_data}
print("These schools have matching records in merged_data but are not in div_data")
setdiff(diff_div, diff_div2)
# Green Mountain College is in merged_data only to 2018 (due to closure and is excluded)
```
#### All divested and rejected schools in 2020 with no NAs for ED and ES, no double counts, allows NAs for divestment status 
```{r ed_data}
# 606 community colleges (likely 2-year) have NAs for ED and ES 
# Keeping schools that have divested in 2023 Q1, or schools that have not divested and have not reversed decisions 
ed_data<- ed_data_null%>%
  filter(!is.na(Endowment_dependency) & !is.na(Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year))

ED_NAs<-ed_data_null%>%filter(is.na(ed_data_null$Endowment_dependency))
ES_NAs<-ed_data_null%>%filter(is.na(ed_data_null$Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year))
print(paste0("There are ", count(ED_NAs)," schools with endowment dependency NAs:"))
head(ED_NAs$`Institution Name`)
```

```{r}
print(paste0("There are ", count(ES_NAs), " schools with endowment size NAs"))
print(ES_NAs$INSTITUTION.NAME)
```

#### All divested and rejected schools (#183) with no NAs in ED, ES, div status
```{r ed_data_copy}
# schools with divestment status, endowment dependency and endowment size, no double counts 
ed_data_copy <- ed_data%>%
  filter(!is.na(ed_data$Divested.))
```

## Graph prep: Divestment 
### Add fiscal quarters and count divestment decisions made in each quarter 
```{r div_bar_data}
# Create list of fiscal quarters to be used in for loop below
qtrs <- list("2012 Q3","2012 Q4","2013 Q1","2013 Q2","2013 Q3","2013 Q4","2014 Q1","2014 Q2","2014 Q3","2014 Q4","2015 Q1","2015 Q2","2015 Q3","2015 Q4","2016 Q1","2016 Q2","2016 Q3","2016 Q4","2017 Q1","2017 Q2","2017 Q3","2017 Q4","2018 Q1","2018 Q2","2018 Q3","2018 Q4", "2019 Q1", "2019 Q2", "2019 Q3", "2019 Q4", "2020 Q1", "2020 Q2", "2020 Q3", "2020 Q4", "2021 Q1", "2021 Q2", "2021 Q3", "2021 Q4","2022 Q1","2022 Q2", "2022 Q3", "2022 Q4", "2023 Q1")

# Create an empty dataframe to store data needed for the bar graph
div_bar_data <- data.frame()

# n gives values for "Cumulative Count"
n <- 0

# a gives values for "Amount Associated with Schools that have Divested"
a <- 0

# For loop iterates through fiscal quarters from list qtrs
for (q in qtrs){
  
  # c gives row numbers 
  # Reset for each fiscal quarter
  c <- 0
  
  # For loop iterates through the fiscal quarters divestment decisions were made in 
  for (val in div_data$Quarter){
    
    # Keeps track of row number
    c<- c + 1
    
    # If statement identifies divestment decisions made in each fiscal quarter
    if (val == q){
      
      # Increases n by one for each instance of divestment
      n <- n + 1
      
      # e gives endowment size of divesting institution
      e <- div_data[c, "Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year"]
      
      # Increase a by endowment size of divesting institution
      a <- a + e
    }
  }
  
  # Adds data for each fiscal quarter to dataframe 
  div_bar_data2 <- data.frame("Cumulative Count"=n, "Quarters"=q, "Amount.Divested" = a)
  div_bar_data <- bind_rows(div_bar_data, div_bar_data2, .id = NULL)
}
```
### more graph prep
```{r div_data2}
library(readxl)
blanks <- read_excel("blanks.xlsx")

#div_data2 has UNITID and Divestment Quarter. 
div_data2 <- inner_join(div_data, blanks, by = "UNITID") %>%
  select(UNITID,INSTITUTION.NAME,Date,Quarter.Change,ChangeDate,Change.of.Type,  Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year,Endowment_dependency,Fossil.Fuel.Exposure,Divested.,TypeOfDivestmentOrig,Type.of.Divestment,Language, School.Name) %>%
  filter(UNITID != "161086")

#Filter for colby college no longer relevant.  Schools with shifts in investments but not policies not treated as taking divestment actions.
```

### Add column giving change in divestment per quarter
```{r div_bar_data}
# Add column giving change in divestment per quarter
div_bar_data$Change.Div <- NA

for (row in 1:nrow(div_bar_data)){
  
  if (row == 1){
    div_bar_data$Change.Div[row] = div_bar_data$Amount.Divested[row]
  }

  else
    div_bar_data$Change.Div[row] = div_bar_data$Amount.Divested[row] - div_bar_data$Amount.Divested[row - 1]
}
```

### Unused Bar Graph 1: Number of Divested Institutions in each quarter 
```{r bar 1}
# Create bar graph 
# Replicates a chart made by Smith College in Excel 
# Two y axes cannot be created in ggplot- this is why the columns (Amount Divested in Billions USD are not labeled)
# div_bar_data also has 132 divested schools in 2022 Q2 
bar1 <- ggplot(div_bar_data, aes(div_bar_data$Quarters)) + geom_col(aes(y=div_bar_data$Amount.Divested)) + geom_line(aes(x=div_bar_data$Quarters, y=div_bar_data$Cumulative.Count, group=1)) + geom_point(aes(y=div_bar_data$Cumulative.Count)) + ggtitle("Divested Institutions") + labs(x="Year", y="Number of Institutions", z= "Cumulative Endowment Value") + theme_bw() + theme(axis.text.x= element_text(hjust=1), plot.title = element_text(hjust=0.5)) + scale_x_discrete(breaks=c("2013 Q1", "2014 Q1", "2015 Q1", "2016 Q1", "2017 Q1", "2018 Q1", "2019 Q1", "2020 Q1", "2021 Q1", "2022 Q1","2023 Q1"), labels=c("2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022", "2023"))

bar1
```


### Unused Bar Graph 2: Endowment Values of Divested Institutions
```{r div_bar_data.long}
# Reformat data for bar graph
colnames(div_bar_data)[colnames(div_bar_data) == "Cumulative.Count"] <- "Cumulative.Count.Div"
div_bar_data_copy <- div_bar_data
div_bar_data_copy <- subset(div_bar_data_copy, select = -c(Cumulative.Count.Div))
colnames(div_bar_data_copy)[colnames(div_bar_data_copy) == "Amount.Divested"] <- "Cumulative Endowment Value"
colnames(div_bar_data_copy)[colnames(div_bar_data_copy) == "Change.Div"] <- "Change in Endowment Value"
div_bar_data_copy <- div_bar_data_copy[c("Quarters", "Change in Endowment Value", "Cumulative Endowment Value")]
div_bar_data.long <- melt(div_bar_data_copy)

# Create bar graph
bar12 <- ggplot(div_bar_data.long, aes(Quarters, value, fill=variable)) + geom_col(position="dodge") + ggtitle("Institutional Divestments") + labs(x= "Year", y = "Endowment Value (Billions USD)", fill = "Change/Cumulative") + theme_bw() + theme(axis.text.x = element_text(hjust=1), plot.title = element_text(hjust = 0.5)) + scale_x_discrete(breaks=c("2013 Q1", "2014 Q1", "2015 Q1", "2016 Q1", "2017 Q1", "2018 Q1", "2019 Q1", "2020 Q1", "2021 Q1", "2022 Q1","2023 Q1"), labels=c("2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021","2022","2023"))

bar12
```

## Graph prep: Rejections 
### Filter for rejected schools (Divested=="No") in academic year 2020
```{r rej_data}
# Bar graph of rejections
# Identify relevant subset of data
# Endowment amount used is most recent figure, eventually may want to recode to find the endowment amount at the time of the rejection decision
#rej_data shows there are 76 schools with initial rejection, matches up the 76 rows in manually compiled rejectedx 
rej_data <- merged_data[which(merged_data$ACAD_YEAR == 2020 & merged_data$Divested. == "No"),]

# Create an empty dataframe to store data needed for the bar graph
rej_bar_data <- data.frame()

# n gives values for "Cumulative Count"
n <- 0

# a gives vaues for "Amount Rejected"
a <- 0

# For loop iterates through fiscal quarters from list qtrs
for (q in qtrs){
  
  # c gives row numbers 
  # Reset for each fiscal quarter
  c <- 0
  
  # For loop iterates through the fiscal quarter rejection decisions were made in 
  for (val in rej_data$Quarter){
    
    # Keeps track of row number
    c<- c + 1
    
    # If statement identifies rejection decisions made in each fiscal quarter
    if (val == q){
      
      # Increases n by one for each rejection
      n <- n + 1
      
      # e gives endowment size of rejecting institution
      e <- rej_data[c, "Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year"]
      
      # Increase a by endowment size of divesting institution
      a <- a + e
    }
  }
  
  # c gives row numbers
  # Reset for second for loop 
  c <- 0
  
  # For loop 
  for (val in rej_data$Reversal.Quarter){
    
    # Keeps track of row number
    c <- c + 1
    
    if (val == q){
      
      # Decreases n by one for each reversal of divestment
      n <-n - 1
      
      # e gives endowment size of rejecting institution
      e <- rej_data[c, "Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year"]
      
      # Decrease a by endowment size of a reversing institution
      a <- a - e
    }
  }
  
 
  # Adds data for each fiscal quarter to dataframe 
  rej_bar_data2 <- data.frame("Cumulative Count"=n, "Quarters"=q, "Amount Rejected" = a)
  rej_bar_data <- bind_rows(rej_bar_data, rej_bar_data2, .id = NULL)
}
```

### Add column giving change in rejections per quarter. 
```{r rej_bar_data}
# Add column giving change in rejections per quarter
rej_bar_data$Change.Rej <- NA

for (row in 1:nrow(rej_bar_data)){
  
  if (row == 1){
    rej_bar_data$Change.Rej[row] = rej_bar_data$Amount.Rejected[row]
  }

  else
    rej_bar_data$Change.Rej[row] = rej_bar_data$Amount.Rejected[row] - rej_bar_data$Amount.Rejected[row - 1]
}
```

### Unused Bar Graph 3: Number of Institutional Rejections
```{r bar2}
## Bar Graph 3: Number of Institutional Rejections

#Create bar graph
bar2 <- ggplot(rej_bar_data, aes(rej_bar_data$Quarters)) + geom_col(aes(y=rej_bar_data$Amount.Rejected)) + geom_line(aes(x=rej_bar_data$Quarters, y=rej_bar_data$Cumulative.Count, group=1)) + geom_point(aes(y=rej_bar_data$Cumulative.Count)) + ggtitle("Institutional Rejections") + labs(x="Year", y="Number of Institutions", z= "Cumulative Endowment Value") + theme_bw() + theme(axis.text.x= element_text(hjust=1), plot.title = element_text(hjust=0.5)) + scale_x_discrete(breaks=c("2013 Q1", "2014 Q1", "2015 Q1", "2016 Q1", "2017 Q1", "2018 Q1", "2019 Q1", "2020 Q1", "2021 Q1","2022 Q1","2023 Q1"), labels=c("2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021","2022","2023"))

bar2

ggsave("Institutional Rejections Through 2023 Q1.png", bar2)

```

### Unused Bar graph 4: Endowment Values of Rejected Institutions
```{r bar22}
# Reformat data for bar graph
colnames(rej_bar_data)[colnames(rej_bar_data) == "Cumulative.Count"] <- "Cumulative.Count.Rej"
rej_bar_data_copy <- rej_bar_data
rej_bar_data_copy <- subset(rej_bar_data_copy, select = -c(Cumulative.Count.Rej))
colnames(rej_bar_data_copy)[colnames(rej_bar_data_copy) == "Amount.Rejected"] <- "Cumulative Endowment Value"
colnames(rej_bar_data_copy)[colnames(rej_bar_data_copy) == "Change.Rej"] <- "Change in Endowment Value"
rej_bar_data_copy <- rej_bar_data_copy[c("Quarters", "Change in Endowment Value", "Cumulative Endowment Value")]
rej_bar_data.long <- melt(rej_bar_data_copy)

# Create bar graph
bar22 <- ggplot(rej_bar_data.long, aes(Quarters, value, fill=variable)) + geom_col(position="dodge") + ggtitle("Institutional Rejections") + labs(x= "Year", y = "Endowment Value (Billions USD)", fill = "Change/Cumulative") + theme_bw() + theme(axis.text.x = element_text(hjust=1), plot.title = element_text(hjust = 0.5)) + scale_x_discrete(breaks=c("2013 Q1", "2014 Q1", "2015 Q1", "2016 Q1", "2017 Q1", "2018 Q1", "2019 Q1", "2020 Q1", "2021 Q1","2022 Q1","2023 Q1"), labels=c("2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021","2022","2023"))

bar22

ggsave("Endowment Value of Institutional Rejections Through 2022 Q2.png", bar22)
```
## Graph prep: Rejection reasons  
### Pie chart: Condition of rejection 
```{r pie, echo=FALSE, warning=FALSE}
# Data on type of rejection
pie_data <- plyr::count(rejected_detailsx, "Type.of..no.")

# Chart type of rejection
pie <- ggplot(pie_data, aes(x=factor(1), y = freq, fill= pie_data$Type.of..no.)) + geom_bar(stat="identity") + coord_polar("y") + theme_bw() + ggtitle("Conditionality of Rejection") + scale_fill_manual(values = c("darksalmon", "gray60", "slateblue2", "lightskyblue3")) + labs(fill = "Conditionality") + theme(axis.title.x = element_blank(), axis.text =element_blank(), axis.title.y = element_blank(), panel.border = element_blank(), panel.grid = element_blank(), axis.ticks = element_blank(), plot.title=element_text(hjust=0.5)) + geom_text(aes(label=freq, ymax=freq), position = position_stack(vjust=0.5))

pie
```
### Bar graph of all reasons for divestment rejection
```{r bar_new, echo=FALSE, warning=FALSE}

# Subset relevant data
reasons_data <- rejected_detailsx[,c(15:36)]

# Get number of rows
nrow = nrow(reasons_data)

# Sum columns and divide by nrow to get percent that use each reason
reasons <- as.data.frame(colnames(reasons_data))
colnames(reasons)[colnames(reasons) == "colnames(reasons_data)"] <- "names"
reasons$tally <- as.list(colSums(reasons_data))
reasons$tally <- as.numeric(reasons$tally)
reasons$percent <- reasons$tally / nrow*100
reasons$names <- gsub("\\.", " ", reasons$names)
reasons$names[22] <- "Fossil Fuel Companies = Green Energy Companies"

# Bar graph of reasons
bar_reasons <- ggplot(reasons, aes(reasons$names)) + geom_col(aes(y=reasons$percent)) + theme_bw() + ggtitle("Reasons for Divestment Rejection") + theme(axis.text.x = element_text(angle=45, hjust=1), plot.title = element_text(hjust = 0.5)) + labs(x="Reasons", y="Percent of Institutions Citing") 

bar_reasons
```
### Figure 5: Bar graph of top ten reasons for divestment rejection
```{r bar_reasons_10, echo=FALSE, warning=FALSE}
# Data for top 10 reasons
reasons <- reasons[order(reasons$percent),]
reasons_10 <- top_n(reasons, 10, reasons$percent)

# Bar graph of top 10 reasons
bar_reasons_10 <- ggplot(reasons_10, aes(reasons_10$names)) + geom_col(aes(y=reasons_10$percent)) + theme_bw() + theme(axis.text.x = element_text(angle=45, hjust=1), plot.title = element_text(hjust = 0.5)) + labs(x="Reasons", y="Percent of institutions citing") 


bar_reasons_10

ggsave(filename =  "Barron23Fig5_Reasons.jpeg", height = 4, width = 9, units = "in", dpi = 600)
```
### Figure 5 sample size: Reasons for rejection from U.S. HEI rejections of fossil fuel divestment
```{r}
print(paste0("Figure 5: Reasons for rejection from U.S. HEI rejections of fossil fuel divestment [sample size = ", count(rejected_detailsx),"]"))
```


## Graph prep: Full divestment
### Subset by full divestment and calculate # schools fully divested from div_data
```{r full_div_data}
# Subset by full divestment and calculate amount fully divested 
# no double counts 
full_div_data <- subset(div_data, Type.of.Divestment == "Full")

# Make sure to include schools that divested partially and then moved to full
#later_full_div_data <- subset(div_data, Change.of.Type == "Yes")

# Make sure for loop reads quarter of full divestment not quarter of partial divestment
#later_full_div_data$Quarter <- later_full_div_data$Quarter.Change

# Bind into one data frame
#full_div_data <- bind_rows(full_div_data, later_full_div_data, .id = NULL)

# Create an empty dataframe to store data needed for the bar graph
full_bar_data <- data.frame()

# n gives values for "Cumulative Count"
n <- 0

# a gives values for "Amount Fully Divested"
a <- 0

# For loop iterates through fiscal quarters from list qtrs
for (q in qtrs){
    
  # c gives row numbers 
  # Reset for each fiscal quarter
  c <- 0
  
  # For loop iterates through the fiscal quarters divestment decisions were made in 
  for (val in full_div_data$Quarter){
    
    # Keeps track of row number
    c<- c + 1
    
    # If statement identifies divestment decisions made in each fiscal quarter
    if (val == q){
      
      # Increases n by one for each instance of divestment
      n <- n + 1
      
      # e gives endowment size of divesting institution
      e <- full_div_data[c, "Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year"]
      # Increase a by endowment size of divesting institution
      a <- a + e
    }
  }
  
  # Adds data for each fiscal quarter to dataframe 
  full_bar_data2 <- data.frame("Cumulative Count Full"=n, "Quarters"=q, "Amount Fully Divested" = a)
  full_bar_data <- bind_rows(full_bar_data, full_bar_data2, .id = NULL)
}

# Add column giving change in divestment per quarter
full_bar_data$Change.Full.Div <- NA

for (row in 1:nrow(full_bar_data)){
  
  if (row == 1){
    full_bar_data$Change.Full.Div[row] = full_bar_data$Amount.Fully.Divested[row]
  }

  else
    full_bar_data$Change.Full.Div[row] = full_bar_data$Amount.Fully.Divested[row] - full_bar_data$Amount.Fully.Divested[row - 1]
}

```

### Merge divested and rejected schools: 
```{r div_rej_data}
# Merge data for divestment

div_rej_data <- left_join(div_bar_data, rej_bar_data, by = "Quarters")
div_rej_data <- left_join(div_rej_data, full_bar_data, by = "Quarters")
```

### Figure 1 & 2: Line graph for divestment only ($), divestment/rejections ($), divestment/rejections (#)
```{r line to line4}
# Line graph for divestment only ($)
line = ggplot(div_rej_data, aes(div_rej_data$Quarters)) + geom_line(aes(x=div_rej_data$Quarters, y=div_rej_data$Amount.Divested, color="Divested"), size = 1.5, group=1) + ylim(0,300)+labs(x="Year", y="Cumulative endowment value (Billions USD)", color="Divested/rejected") + theme_bw() + theme(axis.text.x = element_text(hjust = 1), plot.title = element_text(hjust = 0.5)) + ylim(0, 253) + scale_color_manual(values=c("indianred1")) + scale_x_discrete(breaks=c("2013 Q1", "2014 Q1", "2015 Q1", "2016 Q1", "2017 Q1", "2018 Q1", "2019 Q1", "2020 Q1", "2021 Q1","2022 Q1","2023 Q1"), labels=c("2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021","2022","2023"))

line

# Line graph for divestment/rejections ($)
line2 = ggplot(div_rej_data ,aes(div_rej_data$Quarters)) + geom_line(aes(x=div_rej_data$Quarters, y=div_rej_data$Amount.Divested, color="Divested"), size = 1.5, group = 1) + geom_line(aes(x= div_rej_data$Quarters, y=div_rej_data$Amount.Rejected, color="Rejected"), size = 1.5, group = 1) +
geom_line(aes(x=div_rej_data$Quarters, y = div_rej_data$Amount.Fully.Divested, color="Fully divested"), size = 1.5, group = 1) + labs(x="Year", y= "Cumulative endowment value (Billions USD)", color="Divested/rejected") + theme_bw() + theme(axis.text.x = element_text(hjust=1), plot.title=element_text(hjust=0.5)) + ylim(0, 300) + scale_color_manual(values=c("indianred1", "royalblue3", "black")) + scale_x_discrete(breaks=c("2013 Q1", "2014 Q1", "2015 Q1", "2016 Q1", "2017 Q1", "2018 Q1", "2019 Q1", "2020 Q1", "2021 Q1","2022 Q1","2023 Q1"), labels=c("2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021","2022","2023"))+
  theme(legend.position = c(0.89, 0.15), legend.background = element_rect(fill="white", size=unit(0.3, "lines"), linetype = "solid", color = "black")) +     theme(axis.title=element_text(size=8))


line2

line3 = ggplot(div_rej_data ,aes(div_rej_data$Quarters)) + geom_line(aes(x=div_rej_data$Quarters, y=div_rej_data$Cumulative.Count.Div, color="Divested"), size = 1.5, group = 1) +
#+ ggtitle("Institutional Divestment Decisions") 
labs(x="Year", y= "Number of institutions", color="Divested/Rejected") + theme_bw() + theme(axis.text.x = element_text(hjust=1), plot.title=element_text(hjust=0.5)) +ylim(0,300)+ scale_color_manual(values=c("indianred1")) + scale_x_discrete(breaks=c("2013 Q1", "2014 Q1", "2015 Q1", "2016 Q1", "2017 Q1", "2018 Q1", "2019 Q1", "2020 Q1", "2021 Q1","2022 Q1","2023 Q1"), labels=c("2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021","2022","2023"))+
  theme(legend.position = c(0.89, 0.15), legend.background = element_rect(fill="white", size=unit(0.3, "lines"), linetype = "solid", color = "black"))

line3

# Line graph for divestment/rejections (#)
line4 = ggplot(div_rej_data ,aes(div_rej_data$Quarters)) + geom_line(aes(x=div_rej_data$Quarters, y=div_rej_data$Cumulative.Count.Div, color="Divested"), size = 1.5, group = 1) + geom_line(aes(x= div_rej_data$Quarters, y=div_rej_data$Cumulative.Count.Rej, color="Rejected"), size = 1.5, group = 1) + 
geom_line(aes(x=div_rej_data$Quarters, y = div_rej_data$Cumulative.Count.Full, color="Fully divested"), size = 1.5, group = 1)  + labs(x="Year", y= "Number of institutions", color="Divested/rejected") + theme_bw() + theme(axis.text.x = element_text(hjust=1), plot.title=element_text(hjust=0.5)) + scale_color_manual(values=c("indianred1", "royalblue3", "black")) + scale_x_discrete(breaks=c("2013 Q1", "2014 Q1", "2015 Q1", "2016 Q1", "2017 Q1", "2018 Q1", "2019 Q1", "2020 Q1", "2021 Q1","2022 Q1","2023 Q1"), labels=c("2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022","2023"))+
  theme(legend.position = c(0.88, 0.16), legend.background = element_rect(fill="white", size=unit(0.3, "lines"), linetype = "solid", color = "black"))

line4

#Save figures 
ggsave(filename =  "Barron23Fig1_CumEndowmentVal.jpeg", line2, height = 6, width = 9, units = "in", dpi = 600)
ggsave(filename =  "Barron23Fig2_AllDecisions.jpeg", line4, height = 6, width = 9, units = "in", dpi = 600)
```

### Figure 1 description: institutional rejections rose more rapidly than divestments by 2016 
```{r div_data_2016}
div_data_2016<-div_rej_data%>%
  filter(Quarters=="2016 Q1")

Z<- (div_data_2016$Cumulative.Count.Rej - div_data_2016$Cumulative.Count.Div)/div_data_2016$Cumulative.Count.Div

print(paste0("Institutional rejections of FFD rose even more rapidly than divestments and represented ",round(Z*100, 1) ,"% more institutions by 2016."))
```
### Figure 1 caption: 138 divesting schools (all forms of FFD), 126 fully divested, and 55(72 max) rejected by 2023 Q1
```{r div_data_2022}
div_data_2023<-div_rej_data%>%
  filter(Quarters=="2023 Q1")
X<- div_data_2023$Cumulative.Count.Div
Z<- div_data_2023$Cumulative.Count.Full
Y<- div_data_2023$Cumulative.Count.Rej #note this is not the max
print(paste0(X, " divesting schools (all forms of FFD), ", Z, " fully divesting schools, and ", Y, "(",max(div_rej_data$Cumulative.Count.Rej) ," max) rejecting schools by 2023 Q1"))
```

## Graph prep: Bubble charts for Types of divestment, fossil fuel exposure, endowment size 
### Prepare data for types of endowment, fossil fuel exposure (divestment risk), endowment size  
```{r bubble_data}
# Bubble charts are made with limited data of fossil fuel exposure (replicating a chart previously made by Smith College)
# Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year is used to evaluate endowment as this is the variable used to calculate endowment dependency above
# Order types of divestment
div_data$Type.of.Divestment <- factor(div_data$Type.of.Divestment, levels = c("Coal only", "Coal and tar sands only", "Intermediate", "Full"))

# Make sure that schools that changed from partial to full are included (code is assuming that all changes are to full divestment)
bubble_data <- div_data
# n gives row number
n <- 0
for (val in bubble_data$Change.of.Type){
  n <- n + 1
  
  if (val == "Yes"){
    bubble_data[n, "Type.of.Divestment"] <- "Full"}
  else
    next
}
# Convert endowment dependency to percent for consistency in axes
bubble_data$Endowment_dependency <- bubble_data$Endowment_dependency * 100
#force princeton ED to 66%
bubble_data$Endowment_dependency <- ifelse(bubble_data$School.Name=="Princeton University", 66, bubble_data$Endowment_dependency)
#force princeton FF to 4.5 (not necessary fix this later Jane)
bubble_data$Fossil.Fuel.Exposure <- ifelse(bubble_data$School.Name == "Princeton University", 4.5, bubble_data$Fossil.Fuel.Exposure)
#Create labels for schools with full divestment and endowment dependency > 9 % 
bubble_data <- bubble_data %>%
  mutate(label_data = ifelse(bubble_data$Endowment_dependency>9|Type.of.Divestment!="Full", School.Name, ""))


#Schools with endowment dependency >10% 
above10ed <- bubble_data %>%
  filter(Endowment_dependency >= 10)
```

### Bubble chart for all schools 
```{r bubble6}
# The last color is used for the regression fit.
bubble6 <- ggplot(bubble_data)+ 
  geom_point(aes(x=Endowment_dependency, y=Fossil.Fuel.Exposure, color=Type.of.Divestment,
                 size=Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year), alpha = 0.75) +
  scale_color_manual(values=c("#E69F00","#F0E442","#7fff00", "#00994C")) + 
  labs(x="Endowment Dependency", y= "Fossil Fuel Exposure", color= "Type of Divestment", size = "Value of Endowment (Billions USD)") +
  ggtitle("Divestment Risk (2012-Present)") + 
  theme(plot.title = element_text(hjust=0.5)) + xlim(0, 70) + ylim(0,7) + 
  scale_size_continuous(range = c(2,8))+  
  geom_text_repel(data = bubble_data, colour = "black", aes(x=Endowment_dependency, y=Fossil.Fuel.Exposure, label=label_data),size = 8.4/.pt, max.overlaps = 1000, nudge_x =0.22, point.padding = 0.1, nudge_y =0.50, seed = 42, check_overlap = TRUE)+  theme_bw(base_size = 11)+theme(plot.title=element_text(hjust=0.5))+ theme(legend.position = c(0.8, 0.2)) 

bubble6
```

### Figure 4a: Endowment dependency vs fossil fuel exposure 2012-2017 
```{r bubble_data}
# Bubble charts are made with limited data of fossil fuel exposure (replicating a chart previously made by Smith College)
# Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year is used to evaluate endowment as this is the variable used to calculate endowment dependency above


bubble_data <- div_data

#ensure partials are lumped with intermediate
bubble_data <- bubble_data %>% mutate(TypeOfDivestmentOrig=str_replace_all(TypeOfDivestmentOrig,'Partial','Intermediate')) %>%
mutate(TypeOfDivestmentOrig=str_replace_all(TypeOfDivestmentOrig,'Intermediate ','Intermediate'))

#order as factors
bubble_data$Type.of.Divestment <- factor(bubble_data$Type.of.Divestment, levels = c("Coal only", "Coal and tar sands only", "Intermediate", "Full"))
bubble_data$TypeOfDivestmentOrig <- factor(bubble_data$TypeOfDivestmentOrig, levels = c("Coal only", "Coal and tar sands only", "Intermediate", "Full"))

# Convert endowment dependency to percent for consistency in axes
bubble_data$Endowment_dependency <- bubble_data$Endowment_dependency * 100
#force princeton ED to 66%
bubble_data$Endowment_dependency <- ifelse(bubble_data$School.Name=="Princeton University", 66, bubble_data$Endowment_dependency)
#force princeton FF to 4.5 (not necessary fix this later Jane)
bubble_data$Fossil.Fuel.Exposure <- ifelse(bubble_data$School.Name == "Princeton University", 4.5, bubble_data$Fossil.Fuel.Exposure)
#Create labels for schools with full divestment and endowment dependency > 9 % 
bubble_data <- bubble_data %>%
  mutate(label_data = ifelse(bubble_data$Endowment_dependency>9|TypeOfDivestmentOrig!="Full", School.Name, ""))
```

### Figure 4a: Endowment dependency vs fossil fuel exposure 2012-2017 
```{r bubble_data}
# Bubble charts are made with limited data of fossil fuel exposure (replicating a chart previously made by Smith College)
# Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year is used to evaluate endowment as this is the variable used to calculate endowment dependency above


bubble_data <- div_data

#ensure partials are lumped with intermediate
bubble_data <- bubble_data %>% mutate(TypeOfDivestmentOrig=str_replace_all(TypeOfDivestmentOrig,'Partial','Intermediate')) %>%
mutate(TypeOfDivestmentOrig=str_replace_all(TypeOfDivestmentOrig,'Intermediate ','Intermediate'))

#order as factors
bubble_data$Type.of.Divestment <- factor(bubble_data$Type.of.Divestment, levels = c("Coal only", "Coal and tar sands only", "Intermediate", "Full"))
bubble_data$TypeOfDivestmentOrig <- factor(bubble_data$TypeOfDivestmentOrig, levels = c("Coal only", "Coal and tar sands only", "Intermediate", "Full"))

# Convert endowment dependency to percent for consistency in axes
bubble_data$Endowment_dependency <- bubble_data$Endowment_dependency * 100
#force princeton ED to 66%
bubble_data$Endowment_dependency <- ifelse(bubble_data$School.Name=="Princeton University", 66, bubble_data$Endowment_dependency)
#force princeton FF to 4.5 (not necessary fix this later Jane)
bubble_data$Fossil.Fuel.Exposure <- ifelse(bubble_data$School.Name == "Princeton University", 4.5, bubble_data$Fossil.Fuel.Exposure)
#Create labels for schools with full divestment and endowment dependency > 9 % 
bubble_data <- bubble_data %>%
  mutate(label_data = ifelse(bubble_data$Endowment_dependency>9|TypeOfDivestmentOrig!="Full", School.Name, ""))
```

### Figure 4a: Endowment dependency vs fossil fuel exposure 2012-2017 
```{r bubbledatapre2018 to bubble7}
bubbledatapre2018 <- bubble_data %>%
  filter(substr(Quarter, 0, 4) == "2017" | substr(Quarter, 0, 4) == "2016" | substr(Quarter, 0, 4) == "2015" | substr(Quarter, 0, 4) == "2014" | substr(Quarter, 0, 4) == "2013" | substr(Quarter, 0, 4) == "2012" | substr(Quarter, 0, 4) == "2011") %>%    mutate(label_data_2 = ifelse(Endowment_dependency>15 | Fossil.Fuel.Exposure>7.5, INSTITUTION.NAME, ""))

bubble4a <- ggplot(bubbledatapre2018) + geom_point(aes(x=Endowment_dependency, y=Fossil.Fuel.Exposure, size=Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year, color=TypeOfDivestmentOrig) , alpha = 0.75) +    scale_color_manual(values=c("#E69F00","#F0E442","#7fff00", "#00994C")) + labs(x="Estimated endowment dependence", y= "Fossil fuel exposure", color= "Type of divestment", size = "Value of endowment (billions USD)") + ggtitle("2012-2017") + theme(plot.title = element_text(hjust=0.5)) + xlim(0, 70) + ylim(-0.5,10.5) + scale_size_continuous(range = c(2,8))+ 
  geom_text_repel(data = bubbledatapre2018, colour = "black", aes(x=Endowment_dependency, y=Fossil.Fuel.Exposure, label=label_data_2),size = 8/.pt, max.overlaps = 12, point.padding = 0.2, box.padding = .6, seed = 42, check_overlap = TRUE)+  theme_bw(base_size = 11)+
  theme(plot.title=element_text(hjust=0.5),
        legend.background = element_rect(fill="white", size=unit(0.3, "lines"), linetype = "solid", color = "black"),
        legend.box.background = element_blank(), 
        legend.position = c(0.8, 0.65), 
        legend.title = element_text(size = 8), 
        legend.text = element_text(size = 6), 
        legend.key.size = unit(0.5,"cm"),
        legend.box.margin = margin(0.2, 0.2, 0.2, 0.2, "cm"))

bubble4a <- bubble4a +   geom_point(alpha=0.7, aes(x=5.448683,y=3),colour="#E69F00", size=3.699979)


bubble4a


```

### Figure 4b: Endowment dependency vs fossil fuel exposure 2018-2022 
```{r bubbledatapost2018}
bubbledatapost2018 <- bubble_data %>% 
  filter(substr(Quarter, 0, 4) == "2018" | substr(Quarter, 0, 4) == "2019" | substr(Quarter, 0, 4) == "2020" | substr(Quarter, 0, 4) == "2021" | substr(Quarter, 0, 4) == "2022"| substr(Quarter, 0, 4) == "2023") %>%
  mutate(label_data_3 = ifelse(Endowment_dependency>13, INSTITUTION.NAME, ""))


# Graph 2018-2022
bubble4b <- ggplot(bubbledatapost2018) + 
  geom_point(alpha=0.7, aes(x=35.64197926,y=2.6, size=31.201686000),colour="#7fff00") + 
geom_point(alpha = 0.75, aes(x=Endowment_dependency, y=Fossil.Fuel.Exposure,
                               size=Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year, color=Type.of.Divestment)) +
  scale_color_manual(values=c("#E69F00","#7fff00", "#00994C")) + theme_bw() + 
  labs(x="Estimated endowment dependence", y= "Fossil fuel exposure", size = "Value of endowment (billions USD)", 
       color= "Type of divestment") + 
  ggtitle("2018-present") + 
  theme(plot.title = element_text(hjust=0.5)) + xlim(0, 75) + ylim(-0.5,10.5) + 
  scale_size_continuous(range = c(2,8)) + 
  geom_text_repel(data = bubbledatapost2018, colour = "black", 
                  aes(x=Endowment_dependency, y=Fossil.Fuel.Exposure, label=label_data_3), 
                  size = 8/.pt, max.overlaps=20, point.padding = 0.6, box.padding = .3, seed = 65, nudge_y =-0.6) + 
  theme_bw(base_size = 11)+ 
  theme(plot.title=element_text(hjust=0.6), legend.position = "none", legend.box.margin = margin(0.2, 0.2, 0.2, 0.2, "cm"),
legend.box.background = element_rect(color="black", size=0.5))                                    

#Move Yale Fossil Fuel Exposure from 0 to 2.6 in 2021, add geom_point. Divestment announcement impacted the holdings 
#For Yale University to show in unbolded fontface, please install.packages("showtext") and run the next two lines. Running the next two lines with the whole rmd will repel all text and label size to size 3.  
#showtext_auto(). , family = "serif)
bubble4b <- bubble4b + annotate(geom="text", x=33, y=2.9, label="Yale University",cex=2.9)

bubble4b

ggsave("Bubble Chart Post 2018_no ST annotate_no family_2.5.png", bubble4b, width = 9, height = 6, units = "in", dpi = 600)

#bubbledatapost_post2019<- bubble_data %>% 
#  filter(substr(Quarter, 0, 4) == "2019" | substr(Quarter, 0, 4) == "2020" | substr(Quarter, 0, 4) == "2021" | substr(Quarter, 0, 4) == "2022") %>%
#  mutate(label_data_3 = ifelse(Endowment_dependency>15, INSTITUTION.NAME, "")) 


# Graph 2019-2022
#bubble_post2019 <- ggplot(bubbledatapost_post2018) + geom_point(alpha = 0.75, aes(x=Endowment_dependency, y=Fossil.Fuel.Exposure, size=Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year, color=Type.of.Divestment)) + scale_color_manual(values=c("#F0E442", "#00994C")) + theme_bw() + labs(x="Endowment Dependency", y= "Fossil Fuel Exposure", color= "Type of Divestment", size = "Value of Endowment (Billions USD)") + ggtitle("Divestment Risk (2019-Present)") + theme(plot.title = element_text(hjust=0.5)) + xlim(0, 75) + ylim(0,10) + scale_size_continuous(range = c(2,8)) + geom_text_repel(data = bubbledatapost2018, colour = "black", aes(x=Endowment_dependency, y=Fossil.Fuel.Exposure, label=label_data_3),size = 8.4/.pt, max.overlaps = 1000, point.padding = 0.6, box.padding = .3, seed = 65,  nudge_y =-0.6)+  theme_bw(base_size = 11)

#bubble_post2019
```
```{r}
aligned_div_risk<-plot_grid(bubble4a, bubble4b, labels = c('(a)', '(b)'), align = "h" )
aligned_div_risk

ggsave(filename =  "Barron23Fig4_DivRisks.jpeg", aligned_div_risk, height = 5, width = 11, units = "in", dpi = 600)

```

### Highlight: Only XX of YY divesting schools reported fossil fuel exposure. 
```{r highlight}
reporting <-colSums(!is.na(bubble_data))
ffereport <- reporting[19]
divreport <- reporting[21]
print(paste0("Note that only ", ffereport  ," of ", divreport, " divesting schools reported fossil fuel exposure."))
print(paste0("For the subset of schools that reported fossil fuel share of endowment (",round(ffereport/divreport*100, 1),"%)"))
```

### Unused bubble: Divestment risk 2012-present 
```{r bubble_data_all}
# Graph using all data
bubble_data_all<-bubble_data%>%
  mutate(label_data_full = ifelse(bubble_data$Endowment_dependency>15| Fossil.Fuel.Exposure>7, INSTITUTION.NAME, ""))

bubble6 <- ggplot(bubble_data_all) + 
  geom_point(alpha = 0.75,aes(x=Endowment_dependency, y=Fossil.Fuel.Exposure, size=Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year, color=Type.of.Divestment)) + 
  scale_color_manual(values=c("#E69F00","#F0E442","#7fff00", "#00994C")) +
  theme_bw() + 
  labs(x="Endowment Dependency", y= "Fossil Fuel Exposure", color= "Type of Divestment", size = "Value of Endowment (Billions USD)") + ggtitle("Divestment Risk (2012-Present)") + theme(plot.title = element_text(hjust=0.5)) + xlim(0, 70) + ylim(-0.5,10.5) + scale_size_continuous(range = c(2,8)) + 
  geom_text_repel(data = bubble_data_all, colour = "black", aes(x=Endowment_dependency, y=Fossil.Fuel.Exposure, label =label_data_full),size = 8.4/.pt, max.overlaps = 13, point.padding = 0.6,  box.padding = 0.4, nudge_x =0.78, seed = 42)+  theme_bw(base_size = 11)+theme(plot.title = element_text(hjust=0.5))

bubble6

```

## Endowment Dependency vs Type of divestment 
### Figure 3: Endowment dependency of divested institutions 
```{r endowdepend6}
# Extract years from the dates
div_data2$Date<- as.Date(div_data2$Date) 
div_data2$ChangeDate<- as.Date(div_data2$ChangeDate) 

div_data2$Endowment_dependency <- ifelse(div_data2$INSTITUTION.NAME== "Princeton University", .66, div_data$Endowment_dependency)

div_data2<-div_data2%>%
    mutate(label_data_3 = ifelse( Endowment_dependency>0.15, INSTITUTION.NAME, ""))

endowdepend6 = ggplot(div_data2 ,aes(x = ChangeDate, y = Endowment_dependency, color=Type.of.Divestment) ,alpha = 0.75)+ geom_point() + scale_shape_manual(values = c(4, 3, 21, 8, 7)) + labs(x="Year", y= "Endowment dependence") + theme_bw()   + theme(plot.title = element_text(hjust=0.5)) +
  scale_color_manual(values=c("#F0E442","#E69F00","#00994C","#7fff00"))+geom_text_repel(data = div_data2, colour = "black", aes(x=ChangeDate, y=Endowment_dependency, label=label_data_3),size = 5/.pt, max.overlaps = 10,seed = 42)+  theme_bw(base_size = 11)+theme(plot.title = element_text(hjust=0.5), legend.position = c(0.15, 0.8),legend.background = element_rect(fill="white", size=unit(0.3, "lines"), linetype = "solid", color = "black")) + labs(color='Type of divestment')


endowdepend6


endowdepend7 = ggplot(div_data2 ,aes(x = Date, y = Endowment_dependency, color=TypeOfDivestmentOrig) ,alpha = 0.75)+ 
  geom_point() +labs(x="Year", y= "Endowment dependence") + theme_bw() + theme(plot.title = element_text(hjust=0.5)) +
  scale_color_manual(values=c("#F0E442","#E69F00","#00994C","#7fff00"))+geom_text_repel(data = div_data2, colour = "black", aes(x=Date, y=Endowment_dependency, label=label_data_3),size = 5/.pt, max.overlaps = 10,seed = 42)+  theme_bw(base_size = 11)+theme(plot.title = element_text(hjust=0.5), legend.position = c(0.15, 0.8),legend.background = element_rect(fill="white", size=unit(0.3, "lines"), linetype = "solid", color = "black")) + labs(color='Type of divestment')

  endowdepend7
  
```

```{r}
# make a new dataset which duplicates the original dataset but change the date to original date if change.of.type = yes 
div_data3<- div_data2 %>% filter(Change.of.Type == "Yes") %>%
              mutate(DateFinal = Date,  DivFinal=TypeOfDivestmentOrig)
#combine div_data2 and div_data3 so that schools that changed divestment status appears twice
new_div_data2 <- div_data2 %>%
  mutate(DateFinal = ChangeDate, DivFinal = Type.of.Divestment)%>%
  bind_rows(div_data3)%>%
  select(INSTITUTION.NAME, DateFinal,DivFinal,Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year,Endowment_dependency,label_data_3)

endowdepend8 = ggplot(new_div_data2 ,aes(x = DateFinal, y = Endowment_dependency, color=DivFinal) ,alpha = 0.75)+ 
  geom_point() +labs(x="Year", y= "Endowment dependence") + theme_bw() + theme(plot.title = element_text(hjust=0.5)) +
  scale_color_manual(values=c("#F0E442","#E69F00","#00994C","#7fff00"))+geom_text_repel(data = new_div_data2, colour = "black", aes(x=DateFinal, y=Endowment_dependency, label=label_data_3),size = 5/.pt, max.overlaps = 10,seed = 42)+  theme_bw(base_size = 11)+theme(plot.title = element_text(hjust=0.5), legend.position = c(0.15, 0.8),legend.background = element_rect(fill="white", size=unit(0.3, "lines"), linetype = "solid", color = "black")) + labs(color='Type of divestment')

  endowdepend8

ggsave(filename =  "Barron23Fig3_EndowmentDependencyDiv.jpeg", endowdepend8, height = 4, width = 8, units = "in", dpi = 600)

```

## Endowment size vs Type of Divestment 
```{r hist_data, include=FALSE, warning=FALSE}
# Endowment size is measured by Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year
# Figure out bin width (rounds to 0.033)
bin_width <-diff(range(ed_data$Endowment_dependency, na.rm = TRUE))/30

# For for loop
c <- 1

# Create empty list
bins_x_coor <- vector(mode = "list", length = 30)

# Add bins to list
for (i in 1:30){
  bins_x_coor[i] <- (bin_width * c)-(bin_width/2)
  c <- c + 1 
}

# NB: For histograms in r "by default, bin counts include values less than or equal to the bin's right break point and strictly greater than the bin's left break point, except for the leftmost bin, which includes its left break point," according to https://planspace.org/20141225-how_does_r_calculate_histogram_break_points/. This was used to structure the code below. 

# Create dataframe to store data needed for the histogram
hist_data <- data.frame("Bins" = I(bins_x_coor))
hist_data$Endowment_values <- 0

# n keeps track of row numbers
n <- 0

for (i in ed_data$UNITID){
  
  # Update row number
  n <- n + 1
  
  # Pull data for given institution
  e = ed_data[n, "Endowment_dependency"]
  v = ed_data[n, "Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year"]
  
  if (is.na(e)){
    next
  }
  if (e >= 0 & e <= bin_width) {
    hist_data$Endowment_values[1] <- hist_data$Endowment_values[1] + v
  }
  
  if (e > bin_width & e <= (bin_width*2)) {
    hist_data$Endowment_values[2] <- hist_data$Endowment_values[2] + v
  }
  if (e > (bin_width*2) & e <= (bin_width *3)) {
    hist_data$Endowment_values[3] <- hist_data$Endowment_values[3] + v
  }
  if (e > (bin_width*3) & e <= (bin_width *4)) {
    hist_data$Endowment_values[4] <- hist_data$Endowment_values[4] + v
  }
  if (e > (bin_width*4) & e <= (bin_width *5)) {
    hist_data$Endowment_values[5] <- hist_data$Endowment_values[5] + v
  }
  if (e > (bin_width*5) & e <= (bin_width *6)) {
    hist_data$Endowment_values[6] <- hist_data$Endowment_values[6] + v
  }
  if (e > (bin_width*6) & e <= (bin_width *7)) {
    hist_data$Endowment_values[7] <- hist_data$Endowment_values[7] + v
  }
  if (e > (bin_width*7) & e <= (bin_width *8)) {
    hist_data$Endowment_values[8] <- hist_data$Endowment_values[8] + v
  }
  if (e > (bin_width*8) & e <= (bin_width *9)) {
    hist_data$Endowment_values[9] <- hist_data$Endowment_values[9] + v
  }
  if (e > (bin_width*9) & e <= (bin_width *10)) {
    hist_data$Endowment_values[10] <- hist_data$Endowment_values[10] + v
  }
  if (e > (bin_width*10) & e <= (bin_width *11)) {
    hist_data$Endowment_values[11] <- hist_data$Endowment_values[11] + v
  }
  if (e > (bin_width*11) & e <= (bin_width *12)) {
    hist_data$Endowment_values[12] <- hist_data$Endowment_values[12] + v
  }
  if (e > (bin_width*12) & e <= (bin_width *13)) {
    hist_data$Endowment_values[13] <- hist_data$Endowment_values[13] + v
  }
  if (e > (bin_width*13) & e <= (bin_width *14)) {
    hist_data$Endowment_values[14] <- hist_data$Endowment_values[14] + v
  }
  if (e > (bin_width*14) & e <= (bin_width *15)) {
    hist_data$Endowment_values[15] <- hist_data$Endowment_values[15] + v
  }
  if (e > (bin_width*15) & e <= (bin_width *16)) {
    hist_data$Endowment_values[16] <- hist_data$Endowment_values[16] + v
  }
  if (e > (bin_width*16) & e <= (bin_width *17)) {
    hist_data$Endowment_values[17] <- hist_data$Endowment_values[17] + v
  }
  if (e > (bin_width*17) & e <= (bin_width *18)) {
    hist_data$Endowment_values[18] <- hist_data$Endowment_values[18] + v
  }
  if (e > (bin_width*18) & e <= (bin_width *19)) {
    hist_data$Endowment_values[19] <- hist_data$Endowment_values[19] + v
  }
  if (e > (bin_width*19) & e <= (bin_width *20)) {
    hist_data$Endowment_values[20] <- hist_data$Endowment_values[20] + v
  }
  if (e > (bin_width*20) & e <= (bin_width *21)) {
    hist_data$Endowment_values[21] <- hist_data$Endowment_values[21] + v
  }
  if (e > (bin_width*21) & e <= (bin_width *22)) {
    hist_data$Endowment_values[22] <- hist_data$Endowment_values[22] + v
  }
  if (e > (bin_width*22) & e <= (bin_width *23)) {
    hist_data$Endowment_values[23] <- hist_data$Endowment_values[23] + v
  }
  if (e > (bin_width*23) & e <= (bin_width *24)) {
    hist_data$Endowment_values[24] <- hist_data$Endowment_values[24] + v
  }
  if (e > (bin_width*24) & e <= (bin_width *25)) {
    hist_data$Endowment_values[25] <- hist_data$Endowment_values[25] + v
  }
  if (e > (bin_width*25) & e <= (bin_width *26)) {
    hist_data$Endowment_values[26] <- hist_data$Endowment_values[26] + v
  }
  if (e > (bin_width*26) & e <= (bin_width *27)) {
    hist_data$Endowment_values[27] <- hist_data$Endowment_values[27] + v
  }
  if (e > (bin_width*27) & e <= (bin_width *28)) {
    hist_data$Endowment_values[28] <- hist_data$Endowment_values[28] + v
  }
  if (e > (bin_width*28) & e <= (bin_width *29)) {
    hist_data$Endowment_values[29] <- hist_data$Endowment_values[29] + v
  }
  if (e > (bin_width*29) & e <= (1)) {
    hist_data$Endowment_values[30] <- hist_data$Endowment_values[30] + v
  }
}

```
### Unused Histogram of endowment values
```{r hist3, echo=FALSE, warning=FALSE}
# Convert variable type
#hist_data$Bins <- as.numeric(hist_data$Bins)

# Convert to percent
#hist_data$Binspercent <- hist_data$Bins * 100

# Graph
#value_graph <- ggplot(hist_data, aes(hist_data$Binspercent)) + geom_col(aes(y=hist_data$Endowment_values)) + geom_vline(xintercept = 10) + geom_vline(xintercept = smith_ed_1 *100) + ggtitle("All institutions - endowment value by endowment dependency") + labs(x="Endowment dependency (%)", y="Value of endowments") + theme_bw() + theme(axis.text.x= element_text(hjust=1), plot.title = element_text(hjust=0.5))

#value_graph
```
### SI Figure 3: Endowment size of divested institutions 
```{r endowsize}
div_data2$Endowment_dependency <- ifelse(div_data2$INSTITUTION.NAME== "Princeton University", .66, div_data$Endowment_dependency)

div_data2<-div_data2%>%
    mutate(label_data_3 = ifelse(TypeOfDivestmentOrig!="Full" | Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year>0, INSTITUTION.NAME, ""))

endowsize = ggplot(div_data2 ,aes(x = ChangeDate, y = Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year, color=Type.of.Divestment) ,alpha = 0.75)+ 
  geom_point() + scale_shape_manual(values = c(4, 3, 21, 8, 7)) + labs(x="Year", y= "Value of Endowment (Billions USD)") + ggtitle("Endowment Size of Divested Institutions") + theme_bw() + theme(plot.title = element_text(hjust=0.5)) +
  scale_color_manual(values=c("#E69F00","#F0E442","#00994C","#7fff00"))+geom_text_repel(data = div_data2, colour = "black", aes(x=ChangeDate, y=Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year, label=label_data_3),size = 5/.pt, max.overlaps = 10,seed = 42)+  theme_bw(base_size = 11)+theme(plot.title = element_text(hjust=0.5)) + theme(plot.title = element_text(hjust=0.5), legend.position = c(0.15, 0.78),legend.background = element_rect(fill="white", size=unit(0.3, "lines"), linetype = "solid", color = "black"))+ labs(color='Type of divestment')

endowsize

ggsave("Barron23FigSI3_EndowmentSizeDivested.jpeg", endowsize, width = 8, height = 4, units = "in", dpi = 600)

```

### Endowment dependency of Whitman College 
```{r}
div_data2_whitman<- div_data2%>%
  filter(School.Name=="Whitman College")
whitman_dependency<- div_data2_whitman$Endowment_dependency
whitman_dependency*100
```

## ED ES and Divestment decision: Box and whisker plots
### 2012-2018 full divestment vs rejection data prep 
```{r ed_data_copy_pre2017_full and ed_data_copy_post2017_full, echo=FALSE, warning=FALSE}
# ed_data_copy does not include NAs, use ed_data to include NAs
ed_data_copy <- left_join(ed_data_copy, rejected_detailsx, by = "UNITID")

# ED data from 2012-2017, filter to full investment vs rejection  
ed_data_copy_pre2017_full <- ed_data_copy %>% 
  filter(substr(Quarter.x, 0, 4) == "2012" | substr(Quarter.x, 0, 4) == "2013" | substr(Quarter.x, 0, 4) == "2014" | substr(Quarter.x, 0, 4) == "2015" | substr(Quarter.x, 0, 4) == "2016" | substr(Quarter.x, 0, 4) == "2017")%>%
  filter(Type.of.Divestment.x == "Full" | Divested..x == "No")

# ED data from 2018-2022, filter to full investment vs rejection  
ed_data_copy_post2017_full <- ed_data_copy %>% 
  filter(substr(Quarter.x, 0, 4) == "2018" | substr(Quarter.x, 0, 4) == "2019" | substr(Quarter.x, 0, 4) == "2020" | substr(Quarter.x, 0, 4) == "2021" | substr(Quarter.x, 0, 4) == "2022")%>%
  filter(Type.of.Divestment.x == "Full" | Divested..x == "No")
```

### 2012-2017 vs 2018-2022 Endowment Size vs divestment decision (fully divested vs rejected) 
```{r ES_pre2017_box_full and ES_post2017_box_full}
ES_pre2017_box_full <-  ggplot(ed_data_copy_pre2017_full) + geom_boxplot(aes(x=Divested..x, y=Value.of.endowment.assets.at.the.end.of.the.fiscal.year)) + geom_jitter(aes(x=Divested..x, y=Value.of.endowment.assets.at.the.end.of.the.fiscal.year),shape=16, position=position_jitter(0.2)) + theme_bw() +ggtitle("2012 - 2017") + labs(x="Divestment decision (Yes = Fully divested, No = Rejected)", y= "Endowment size (Billions USD)") + theme(plot.title=element_text(hjust=0.5))
ES_pre2017_box_full

ES_post2017_box_full <-  ggplot(ed_data_copy_post2017_full) + geom_boxplot(aes(x=Divested..x, y=Value.of.endowment.assets.at.the.end.of.the.fiscal.year)) + geom_jitter(aes(x=Divested..x, y=Value.of.endowment.assets.at.the.end.of.the.fiscal.year),shape=16, position=position_jitter(0.2)) + theme_bw() +ggtitle("2018 - 2022") + labs(x="Divestment decision (Yes = Fully divested, No = Rejected)", y= "Endowment size (Billions USD)") + theme(plot.title=element_text(hjust=0.5))
ES_post2017_box_full
```
### 2012-2018 vs 2019-2022 Endowment Dependency vs divestment decision (fully divested vs rejected) 
```{r ED_pre2017_box_full and ED_post2017_box_full}
ED_pre2017_box_full <-  ggplot(ed_data_copy_pre2017_full) + geom_boxplot(aes(x=Divested..x, y=Endowment_dependency)) + geom_jitter(aes(x=Divested..x, y=Endowment_dependency),shape=16, position=position_jitter(0.2)) + theme_bw() +ggtitle("2012 - 2017") + labs(x="Divestment decision (Yes = Fully divested, No = Rejected)", y= "Endowment dependency") + theme(plot.title=element_text(hjust=0.5))
ED_pre2017_box_full

ED_post2017_box_full <-  ggplot(ed_data_copy_post2017_full) + geom_boxplot(aes(x=Divested..x, y=Endowment_dependency)) + geom_jitter(aes(x=Divested..x, y=Endowment_dependency),shape=16, position=position_jitter(0.2)) + theme_bw() +ggtitle("2018 - 2022") + labs(x="Divestment decision (Yes = Fully divested, No = Rejected)", y= "Endowment dependency") + theme(plot.title=element_text(hjust=0.5))
ED_post2017_box_full
```
### Combined 2012-2017 vs 2018-2022, ED vs Div decision and ES vs Div decision
```{r}
plot_grid ( ED_pre2017_box_full , ED_post2017_box_full , align = "h" )
plot_grid ( ES_pre2017_box_full , ES_post2017_box_full, align = "h" )

pre2017_box<-plot_grid ( ED_pre2017_box_full , ES_pre2017_box_full , align = "h" )
post2017_box<-plot_grid ( ES_post2017_box_full, ED_post2017_box_full, align = "h" )
fullpre2017_box<-plot_grid ( ED_pre2017_box_full , ES_pre2017_box_full , align = "h" )

fullpre2017_box

ggsave("Endowment Dependency and endowment size box plot 2012-2018.png", pre2017_box, width = 10, height = 4)
ggsave("Endowment Dependency and endowment size box plot 2018-2022.png", post2017_box, width = 10, height = 4)
ggsave("Endowment Dependency and endowment size box plot 2018-2022.png", fullpre2017_box, width = 10, height = 4)
ggsave("Barron23FigSI2_EndowmentSizeDivested.jpeg", fullpre2017_box, width = 10, height = 4, units = "in", dpi = 600)

```

## Testing 

#### Fully divested or rejected schools with no NAs in ED, ES, div status 
```{r ed_data_test}
# 174 schools fully divested or rejected
ed_data_test<-ed_data_copy%>%
  filter(ed_data_copy$Type.of.Divestment.x == 'Full'| ed_data_copy$Divested..x=="No")
```

#### Fully divested schools with no NAs in ED, ES, div status
```{r ed_test_full}
# Should have 128 schools fully divested  
ed_test_full<-ed_data_test%>%
  filter(Type.of.Divestment.x=="Full")
```

### Create dummy variables for Divested vs Rejected
```{r ed_test}
ed_data_test$Rejected = ifelse(ed_data_test$Divested..x=="No" & ed_data_test$Reversed.Decision == 'No',1,0) 
ed_data_test$Divested = ifelse(ed_data_test$Divested..x=="Yes" & ed_data_test$Type.of.Divestment.x == 'Full',1,0)

#Keep only relevant columns  
ed_test<-ed_data_test%>% 
  select(INSTITUTION.NAME, Divested..x,Endowment_dependency,Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year, Quarter.x,Type.of.Divestment.x,Divested, Rejected)
ed_test
```
### Distribution (skewness) of endowment dependency for all institutions, divested institutions, rejected institutions 
```{r hist1 and hist3}
# Histogram of endowment dependency
hist1 <- ggplot(ed_data) + geom_histogram(aes(x=Endowment_dependency)) + geom_vline(xintercept = 0.1) + theme_bw() + ggtitle("All Institutions - Endowment Dependency") + labs(x="Endowment Dependency", y= "Number of Institutions") + theme(plot.title=element_text(hjust=0.5))

hist1

# Select relevant data
smith_ed_1 <- ed_data[which(ed_data[,"School.Name"] == "Smith College"), "Endowment_dependency"]

# Histogram of EDs with intercepts at 10% and Smith's ED
# May want to label intercepts
hist1_2 <- ggplot(ed_data) + geom_histogram(aes(x=Endowment_dependency * 100)) + geom_vline(xintercept = 10) + geom_vline(xintercept = smith_ed_1*100) + theme_bw() + ggtitle("All Institutions - Number of Institutions by Endowment Dependency") + labs(x="Endowment Dependency", y= "Number of Institutions") + theme(plot.title=element_text(hjust=0.5))

hist1_2

# Histogram of endowment dependency (divested instutions)
hist3 <- ggplot(div_data) + geom_histogram(aes(x=Endowment_dependency)) + theme_bw() + ggtitle("Divested Institutions - Endowment Dependency") + labs(x="Endowment Dependency", y= "Number of Institutions") + theme(plot.title=element_text(hjust=0.5))

hist3

# Histogram of endowment dependency (rejected instutions)
hist4 <- ggplot(rej_data) + geom_histogram(aes(x=Endowment_dependency))+ theme_bw() + ggtitle("Rejecting Institutions - Endowment Dependency") + labs(x="Endowment Dependency", y= "Number of Institutions") + theme(plot.title=element_text(hjust=0.5))

hist4

hist5 <- ggplot(ed_test) + geom_histogram(aes(x=Endowment_dependency))+ theme_bw() + ggtitle("Test - Endowment Dependency") + labs(x="Endowment Dependency", y= "Number of Institutions") + theme(plot.title=element_text(hjust=0.5))
hist5
```
### Distribution (skewness) of fossil fuel exposure (divested institutions)
```{r hist2}
# Histogram of endowment exposure (divested institutions)
hist2 <- ggplot(div_data) + geom_histogram(aes(x=Fossil.Fuel.Exposure)) + theme_bw() + ggtitle("Divested Institutions - Fossil Fuel Exposure") + labs(x="Fossil Fuel Exposure", y= "Number of Institutions") + theme(plot.title=element_text(hjust=0.5))

hist2
```

### SI Figure 1: Relationship between endowment size and endowment dependency (R=0.33)
```{r ED_ES}
SI1 <- ggscatter(ed_data, x = "Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year", y ="Endowment_dependency",  
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Endowment Size (Billions of USD)" , ylab ="Endowment dependency")

print(paste0("SI Figure 1. Relationship Between Endowment Size and Dependence (n=", count(ed_data)
, "). Correlation coefficient = 0.33"))

ggsave(filename =  "Barron23FigSI1_EDESRelationship.jpeg", SI1, height = 4, width = 6, units = "in", dpi = 600)


```
## Linear ED vs ES: Endowment size (billions USD) 
```{r mod_ed_es}
mod_ed_es<- lm (Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year~Endowment_dependency, data = ed_data,na.action = na.exclude)
summary(mod_ed_es)
library(broom)
tidy(mod_ed_es)
```

##log ED vs log ES: Log Endowment size (billions USD)  
```{r}
ggscatter(ed_data, x ="Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year", y = "Endowment_dependency",  
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "log Endowment Dependency", ylab = "log Endowment Size (Billions of USD)")+
  geom_point() +
  scale_x_log10()+  scale_y_log10() + ggtitle("Relationship Between Log Endowment Size and Endowment Dependency")
```

```{r mod_log_ed_es}
mod_log_ed_es<- lm (log1p(Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year)~log1p(Endowment_dependency), data = ed_data,na.action = na.exclude)
summary(mod_log_ed_es)
library(broom)
tidy(mod_log_ed_es)
```

### Testing Skewness  
```{r}
library(ggplot2)
ggplot(ed_test, aes(Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year)) +
  geom_histogram(aes(fill = ed_test$Divested..x))+ theme_bw()+ ggtitle("Test - Endowment Size") + labs(x="Endowment Size", y= "Number of Institutions") + theme(plot.title=element_text(hjust=0.5))

hist5 <- ggplot(ed_test) + geom_histogram(aes(x=Endowment_dependency, fill = ed_test$Divested..x))+ theme_bw() + ggtitle("Test - Endowment Dependency") + labs(x="Endowment Dependency", y= "Number of Institutions") + theme(plot.title=element_text(hjust=0.5))
hist5
```

```{r}
#Shapiro-Wilk test
#H0 : the distribution of EDs between reject and divest follow a normal distribution
#H1 : the distribution of EDs between reject and divest NOT follow a normal distribution
# shapiro.test(rstandard(div_rej_log))
#The small p-value leads to reject the null hypothesis of normality.
```

### Logit 2012-2022
```{r}
#Endowment size as predictor - Endowment size on its own
es_logit <- glm(Divested ~ Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year, data = ed_test, family = "binomial")
summary(es_logit)
```

```{r ed_logit}
#For reporting main regression in "Shifts in ED"
ed_logit <- glm(Divested ~ Endowment_dependency, data = ed_test, family = "binomial")
summary(ed_logit)
```
```{r}
#For odds ratio and CI
exp(coefficients(ed_logit))
exp(confint(ed_logit))

```

```{r ed_logit plot}
ggplot(ed_test, aes(x=Endowment_dependency, y=Divested)) + geom_point() +
      stat_smooth(method="glm", color="green", se=FALSE,
                method.args = list(family=binomial))+labs(x="2012-2022 Endowment dependency", y="Divested")+ theme_bw()

```

```{r es_logit plot}

ggplot(ed_test, aes(x=Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year, y=Divested)) + geom_point() +
      stat_smooth(method="glm", color="green", se=FALSE,
                method.args = list(family=binomial))+labs(x="2012-2022 Endowment size", y="Divested")+ theme_bw()

```
###Added to the model with ED
```{r ed_es_logit}
#adding Endowment size to the model with ED
ed_es_logit <- glm(Divested ~ Endowment_dependency+Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year, data = ed_test, family = "binomial")
summary(ed_es_logit)
```
```{r ed_es_logit_plot}
ggplot(ed_test, aes(x=Endowment_dependency + Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year, y=Divested)) + geom_point() +
      stat_smooth(method="glm", color="green", se=FALSE,
                method.args = list(family=binomial))+labs(x="Endowment dependency + endowment size", y="Divested")+ theme_bw()

```

```{r lrtest}
lrtest(ed_logit, ed_es_logit) 
```

### confidence intervals of logit regression
```{r}
exp(coefficients(ed_logit))
exp(confint(ed_logit))
```

### Logit 2012-2017
```{r logit_pre2017}
ed_test_pre2017<-ed_test%>%
  filter(ed_test$Quarter<"2017 Q1")
#Endowment dependency pre-2017
ed_logit_pre2017 <- glm(Divested ~ Endowment_dependency, data = ed_test_pre2017, family = "binomial")
summary(ed_logit_pre2017)

#Endowment size pre-2017
es_logit_pre2017 <- glm(Divested ~ Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year, data = ed_test_pre2017, family = "binomial")
summary(es_logit_pre2017)

#Endowment dependency+endowment size pre-2017
ed_es_logit_pre2017 <- glm(Divested ~ Endowment_dependency+Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year, data = ed_test_pre2017, family = "binomial")
summary(ed_es_logit_pre2017)

```

```{r pre_2017_logit_graphs}
#ED pre-2017
ggplot(ed_test_pre2017, aes(x=Endowment_dependency, y=Divested)) + geom_point() +
      stat_smooth(method="glm", color="green", se=FALSE,
                method.args = list(family=binomial))+labs(x="2012-2017 Endowment dependency", y="Divested")+ theme_bw()

#ES pre-2017
ggplot(ed_test_pre2017, aes(x=Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year, y=Divested)) + geom_point() +
      stat_smooth(method="glm", color="green", se=FALSE,
                method.args = list(family=binomial))+labs(x="2012-2017 Endowment Size (Billions of USD)", y="Divested")+ theme_bw()

#ED+ES pre-2017
ggplot(ed_test_pre2017, aes(x=Endowment_dependency + Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year, y=Divested)) + geom_point() +
      stat_smooth(method="glm", color="green", se=FALSE,
                method.args = list(family=binomial))+labs(x="2012-2017 Endowment dependency + endowment size", y="Divested")+ theme_bw()

```
### Logit 2018-2022
```{r logit_post2017}
ed_test_post2017<- ed_test%>%
  filter(ed_test$Quarter>="2017 Q1")

#Endowment dependency post-2017
ed_logit_post2017 <- glm(Divested ~ Endowment_dependency, data = ed_test_post2017, family = "binomial")
summary(ed_logit_post2017)

#Endowment size  post-2017
es_logit_post2017 <- glm(Divested ~ Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year, data = ed_test_post2017, family = "binomial")
summary(es_logit_post2017)

#Endowment dependency+endowment size post-2017
ed_es_logit_post2017 <- glm(Divested ~ Endowment_dependency+Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year, data = ed_test_post2017, family = "binomial")
summary(ed_es_logit_post2017)

```

```{r logit_post2017_graphs}
#ED post-2017
ggplot(ed_test_post2017, aes(x=Endowment_dependency, y=Divested)) + geom_point() +
      stat_smooth(method="glm", color="green", se=FALSE,
                method.args = list(family=binomial))+labs(x="2018-2022 Endowment dependency", y="Divested")+ theme_bw()

#ES pre-2017
ggplot(ed_test_post2017, aes(x=Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year, y=Divested)) + geom_point() +
      stat_smooth(method="glm", color="green", se=FALSE,
                method.args = list(family=binomial))+labs(x="2018-2022 Endowment Size (Billions of USD)", y="Divested")+ theme_bw()

#ED+ES pre-2017
ggplot(ed_test_post2017, aes(x=Endowment_dependency + Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year, y=Divested)) + geom_point() +
      stat_smooth(method="glm", color="green", se=FALSE,
                method.args = list(family=binomial))+labs(x="2018-2022 Endowment dependency + endowment size", y="Divested")+ theme_bw()

```

### Endowment dependency reported vs calculated.xlsx
```{r}
ED_reported_estimated <- read_excel("Endowment dependency reported vs calculated.xlsx")
ggscatter(ED_reported_estimated, x = "ED_reported", y = "ED_estimated",  
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Endowment dependency reported by the school", ylab = "Endowment dependency estimated from our data")
```

## Summary sentences
According to data from the National Center for Education Statistics (NCES), as of Fall 2020, there is a total of 3982 higher education institutions in the U.S., including both colleges and universities. 
Of the 3982 higher education institutions in the U.S., 2,679 are four-year colleges and 1,303 are two-year colleges. 1,625 public, 2,357 private, 1,660 private non-profit. Total endowment value by fiscal year start 2020 is $675.407269 billion
Source: https://nces.ed.gov/programs/digest/d20/tables/dt20_317.10.asp
### Number of schools & endowment value divested and rejected
```{r}
ed_data_rej<-rej_data%>%
  filter(rej_data$Divested.=="No" & Reversed.Decision=="No")

div_nschools<-nrow(div_data)
div_nschools_over_total<-div_nschools/3982

value_rejected<-sum(ed_data_rej$Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year)
value_divested<-sum(div_data2$Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year)
div_value_over_total<-value_divested/675.407269
div_value_over_rej<-value_divested/value_rejected-1

# Sentence Output 
print(paste0("Schools that have divested from fossil fuels now represent ", round(div_nschools_over_total*100, 1), " % of U.S. HEIs and ", round(div_value_over_total*100, 1), " % of endowment value."))
print(paste0("Roughly ", round(div_value_over_rej*100, 1), " % more endowment value is now associated with U.S. schools that have divested from fossil fuels than with those that have rejected it. "))

```
### Number of schools & endowment value with ED less than Princeton (66%)
```{r}
# Number of schools & endowment value with ED less than Princeton (66%)

ED_less_than_Priceton<-ed_data%>%
  filter(ed_data$Endowment_dependency<0.66)

#double counting if reversed_decision==Yes
ED_more_than_Priceton<-ed_data%>%
  filter(ed_data$Endowment_dependency>0.66)

ed_data_reported_NA<-ed_data%>%
  filter(is.na(ed_data$Divested.))

total_nschools<-nrow(ed_data) 

W<-nrow(ED_less_than_Priceton) 

x<-W/total_nschools

total_value<-sum(ed_data$Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year)
 ED_less_than_Priceton_value<-sum(ED_less_than_Priceton$Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year)
  
ZZ<-(ED_less_than_Priceton_value)/(total_value)*100

#sentence output 
print(paste0(round(x*100,1),"% of U.S. HEIs (",total_nschools, " of which we can estimate endowment dependency) have an endowment dependency below 66% (the highest endowment dependence of a divesting school (i.e. Princeton University)).")) 
print(paste0("Collectively these schools represent ", round(ZZ,1),"% of total endowment value."))

```
Over 99% of 4-year HEIs representing roughly 956% of endowment value are less dependent upon their endowment than at least one recently divested HEI, suggesting that large endowment or high dependence on endowment are no longer strict barriers to fossil fuel divestment for most schools. 

### % schools with high endowment dependence >0.66 represent 95% of total endowment value. At the same time schools with very high dependence on endowments, which now represent only roughly 0.4% of schools and 5% of endowment value
```{r}
ED_more_than_Priceton<-ed_data%>%
  filter(ed_data$Endowment_dependency>=0.66)

ED_more_than_Priceton_value<-sum(ED_more_than_Priceton$Value.of.endowment.assets.at.the.beginning.of.the.fiscal.year)

VV<-(ED_more_than_Priceton_value)/(total_value)

print(paste0("% schools with high endowment dependence >0.66 represent 96% of total endowment value. At the same time schools with very high dependence on endowments, which now represent only roughly ", round(100-99.6,1), "% of schools and ", round(VV*100,1), "% of total endowment value."))

```
### Swarthmore
```{r}
perc.rank <- function(x) trunc(rank(x))/length(x)
ed_data %>% mutate(
Endowment_dependency_rank = perc.rank(Endowment_dependency),
) -> ed_data_rank



print(paste0("Swarthmore College - the first U.S. school to be targeted by a student FFD campaign - is, in retrospect, one of the most challenging targets that could have been chosen as its endowment dependence is nearly 60% in the top 76% of U.S. institutions."))

```

### Figure 1 description: institutional rejections rose more rapidly than divestments by 2016 
```{r div_data_2016}
div_data_2016<-div_rej_data%>%
  filter(Quarters=="2016 Q1")

Z<- (div_data_2016$Cumulative.Count.Rej - div_data_2016$Cumulative.Count.Div)/div_data_2016$Cumulative.Count.Div

print(paste0("Institutional rejections of FFD rose even more rapidly than divestments and represented ",round(Z*100, 1) ,"% more institutions by 2016."))
```
### Figure 1 caption
```{r div_data_2022}
div_data_2022<-div_rej_data%>%
  filter(Quarters=="2023 Q1")
X<- div_data_2022$Cumulative.Count.Div
Z<- div_data_2022$Cumulative.Count.Full
Y<- div_data_2022$Cumulative.Count.Rej
print(paste0(X, " divesting schools (all forms of FFD), ", Z, " fully divesting schools, and ", Y, " rejecting schools by 2023 Q1"))
```


Cumulative U.S. Higher Education Institutions Announcing Fossil Fuel Divestment (or Rejecting Divestment) by Quarter. (n=X divesting schools (all forms of FFD), Z fully divesting schools, and y rejecting schools )

```{r}
X<-count(div_data2)
Y<-count(full_div_data)
Z<-"57"
print(paste0("Cumulative U.S. Higher Education Institutions Announcing Fossil Fuel Divestment (or Rejecting Divestment) by Quarter. (n=",X, " divesting schools (all forms of FFD), ",Y, " fully divesting schools, and ", Z, " rejecting schools )"))
```

### Endowment dependency of Whitman College 
```{r}
div_data2_whitman<- div_data2%>%
  filter(INSTITUTION.NAME=="Whitman College")
whitman_dependency<- div_data2_whitman$Endowment_dependency
Whitman<- whitman_dependency*100

print(paste0("No schools with an endowment dependence above 25% divested fully before Q3 2018 (Whitman College - ",round(Whitman*100, 1), "%)."))

```
Figure 4 Endowment dependence vs fossil fuel exposure of the endowment for schools which reported fossil fuel exposure, all shares in percent. Panel (a) shows divestment announcements 2012-2017, panel (b) shows announcements 2018 through 8/2022. Note that only [x] of [y] schools reported fossil fuel exposure.

### Highlight: Only 106 of 132 (80.3%) divesting schools reported fossil fuel exposure. 
```{r highlight}
colSums(!is.na(bubble_data))
print(paste0("Note that only 106  of 132 divesting schools reported fossil fuel exposure."))
X<- 106/132
print(paste0("For the subset of schools that reported fossil fuel share of endowment (",round(X*100, 1),"%)"))
```
